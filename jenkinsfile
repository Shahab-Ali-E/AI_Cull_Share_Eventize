pipeline {
    agent any
    environment {
        COMPOSE_PROJECT_NAME = 'ai_cull_share_eventize'
    }
    stages {
        stage('Prepare Environment') {
            steps {
                script {
                    // Create a temporary directory to store the env file
                    sh 'mkdir -p /tmp/ai_cull_env'
                }
            }
        }
        stage('Deploy with Docker Compose') {
            steps {
                script {
                    // Use the secret file and pass it to Docker Compose
                    withCredentials([file(credentialsId: 'Ai_Cull_Share_Eventize_Env_File', variable: 'ENV_FILE')]) {
                        sh '''
                            cp $ENV_FILE /tmp/ai_cull_env/.env
                            docker compose --env-file /tmp/ai_cull_env/.env up -d
                        '''
                    }
                }
            }
        }
    }
    post {
        always {
            // Clean up the temporary directory
            sh 'rm -rf /tmp/ai_cull_env'
        }
    }
}
